{
  "info": {
    "name": "HyperArc Backend API",
    "description": "HyperArc Primary Issuance & Settlement Engine APIs",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3001",
      "type": "string"
    },
    {
      "key": "userId",
      "value": "user123",
      "type": "string"
    },
    {
      "key": "issuerUserId",
      "value": "spv-001",
      "type": "string"
    },
    {
      "key": "adminUserId",
      "value": "admin-001",
      "type": "string"
    },
    {
      "key": "productId",
      "value": "1",
      "type": "string"
    },
    {
      "key": "accessToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "nonce",
      "value": "",
      "type": "string"
    },
    {
      "key": "walletAddress",
      "value": "0x1234567890123456789012345678901234567890",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "0. Authentication (SIWE)",
      "item": [
        {
          "name": "Get Nonce",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "var jsonData = pm.response.json();",
                  "pm.collectionVariables.set(\"nonce\", jsonData.nonce);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/auth/nonce",
              "host": ["{{baseUrl}}"],
              "path": ["auth", "nonce"]
            },
            "description": "Get a nonce for SIWE signature. Valid for 5 minutes."
          },
          "response": []
        },
        {
          "name": "Verify SIWE and Login",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "var jsonData = pm.response.json();",
                  "pm.collectionVariables.set(\"accessToken\", jsonData.accessToken);",
                  "pm.collectionVariables.set(\"userId\", jsonData.userId);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"message\": \"localhost:3001 wants you to sign in with your Ethereum account:\\n{{walletAddress}}\\n\\nSign in with Ethereum to HyperArc\\n\\nURI: http://localhost:3001\\nVersion: 1\\nChain ID: 5042002\\nNonce: {{nonce}}\\nIssued At: 2026-02-05T10:30:00.000Z\",\n  \"signature\": \"0x...\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/auth/verify",
              "host": ["{{baseUrl}}"],
              "path": ["auth", "verify"]
            },
            "description": "Verify SIWE signature and obtain JWT token.\n\n**Auto-creates user account**: If this is the first time the wallet address signs in, the backend will automatically:\n1. Create a new user account with userId = `user-{first8chars}`\n2. Create Circle wallets on: ARC-TESTNET, ARB-SEPOLIA, MATIC-AMOY, ETH-SEPOLIA\n3. Link the MetaMask address as an external wallet\n4. Return JWT token for immediate use\n\n**For existing users**: Returns JWT token linked to existing account.\n\n**Steps to use**:\n1. Call GET /auth/nonce to get a nonce\n2. Use frontend (siwe library) to create SIWE message\n3. Sign the message with MetaMask\n4. Submit the complete message and signature to this endpoint\n\n**Example message format**:\n```\nlocalhost:3001 wants you to sign in with your Ethereum account:\n0x1234567890123456789012345678901234567890\n\nSign in with Ethereum to HyperArc\n\nURI: http://localhost:3001\nVersion: 1\nChain ID: 5042002\nNonce: <nonce-from-step-1>\nIssued At: <current-ISO-timestamp>\n```\n\n**Response**:\n```json\n{\n  \"accessToken\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n  \"userId\": \"user-12345678\",\n  \"role\": \"investor\",\n  \"address\": \"0x1234567890123456789012345678901234567890\"\n}\n```"
          },
          "response": []
        },
        {
          "name": "Link External Wallet",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{accessToken}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"message\": \"localhost:3001 wants you to sign in with your Ethereum account:\\n0x1234567890123456789012345678901234567890\\n\\nLink this wallet to your HyperArc account\\n\\nURI: http://localhost:3001\\nVersion: 1\\nChain ID: 5042002\\nNonce: {{nonce}}\\nIssued At: 2026-02-05T10:35:00.000Z\",\n  \"signature\": \"0x...\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/auth/link-wallet",
              "host": ["{{baseUrl}}"],
              "path": ["auth", "link-wallet"]
            },
            "description": "Link an external wallet (MetaMask) to existing account. Requires valid JWT token from prior login.\n\n**Flow**:\n1. User logs in with Circle wallet to get JWT\n2. Sign SIWE message with new MetaMask address\n3. Call this endpoint to link new wallet\n4. Can then login with either wallet address to access same account"
          },
          "response": []
        },
        {
          "name": "Test Protected Endpoint",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{accessToken}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/example/protected",
              "host": ["{{baseUrl}}"],
              "path": ["example", "protected"]
            },
            "description": "Test protected endpoint. Requires valid JWT token in Authorization header."
          },
          "response": []
        }
      ],
      "description": "Ethereum wallet authentication based on EIP-4361 (SIWE). First-time login automatically creates user account and Circle wallets on 4 blockchains (ARC-TESTNET, ARB-SEPOLIA, MATIC-AMOY, ETH-SEPOLIA)."
    },
    {
      "name": "1. Wallet Management",
      "item": [
        {
          "name": "Create Investor Wallet (Multi Chain)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/wallets/{{userId}}?role=investor&blockchains=ARC-TESTNET,ARB-SEPOLIA,MATIC-AMOY,ETH-SEPOLIA",
              "host": ["{{baseUrl}}"],
              "path": ["wallets", "{{userId}}"],
              "query": [
                {
                  "key": "role",
                  "value": "investor",
                  "description": "investor (default), issuer, or admin"
                },
                {
                  "key": "blockchains",
                  "value": "ARC-TESTNET,ARB-SEPOLIA,MATIC-AMOY,ETH-SEPOLIA",
                  "description": "Comma-separated list of blockchains (default: ARC-TESTNET)"
                }
              ]
            },
            "description": "Creates or retrieves wallet with addresses on multiple blockchains.\n\n**Note**: SIWE login automatically creates wallets on all 4 chains (ARC-TESTNET, ARB-SEPOLIA, MATIC-AMOY, ETH-SEPOLIA). Manual creation is only needed for:\n- Issuer wallets\n- Admin wallets\n- Adding additional blockchains to existing wallets\n\n**Response includes**:\n- walletId (Circle wallet ID)\n- addresses for each blockchain\n- wallet state (LIVE/FROZEN)"
          }
        },
        {
          "name": "Create Issuer Wallet",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/wallets/{{issuerUserId}}?role=issuer&blockchains=ARC-TESTNET",
              "host": ["{{baseUrl}}"],
              "path": ["wallets", "{{issuerUserId}}"],
              "query": [
                {
                  "key": "role",
                  "value": "issuer"
                },
                {
                  "key": "blockchains",
                  "value": "ARC-TESTNET",
                  "description": "Blockchain(s) for issuer wallet"
                }
              ]
            },
            "description": "Creates or retrieves an issuer/SPV wallet for a user"
          }
        },
        {
          "name": "Add Blockchains to Existing Wallet",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/wallets/{{userId}}/blockchains?role=investor&blockchains=ARB-SEPOLIA,MATIC-AMOY",
              "host": ["{{baseUrl}}"],
              "path": ["wallets", "{{userId}}", "blockchains"],
              "query": [
                {
                  "key": "role",
                  "value": "investor",
                  "description": "Wallet role"
                },
                {
                  "key": "blockchains",
                  "value": "ARB-SEPOLIA,MATIC-AMOY",
                  "description": "New blockchains to add (comma-separated)"
                }
              ]
            },
            "description": "Adds new blockchain addresses to existing wallet. Creates new Circle wallet with all chains (existing + new)."
          }
        },
        {
          "name": "Get All Wallets for User",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/wallets/{{userId}}",
              "host": ["{{baseUrl}}"],
              "path": ["wallets", "{{userId}}"]
            },
            "description": "Returns all wallets (investor, issuer, etc.) for the user"
          }
        },
        {
          "name": "Get Specific Role Wallet",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/wallets/{{userId}}?role=investor",
              "host": ["{{baseUrl}}"],
              "path": ["wallets", "{{userId}}"],
              "query": [
                {
                  "key": "role",
                  "value": "investor",
                  "description": "investor, issuer, or admin"
                }
              ]
            },
            "description": "Get wallet for specific role with all blockchain addresses"
          }
        },
        {
          "name": "Get Investor Wallet Balance",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/wallets/{{userId}}/balance?role=investor",
              "host": ["{{baseUrl}}"],
              "path": ["wallets", "{{userId}}", "balance"],
              "query": [
                {
                  "key": "role",
                  "value": "investor",
                  "description": "investor (default), issuer, or admin"
                }
              ]
            }
          }
        },
        {
          "name": "Get Issuer Wallet Balance",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/wallets/{{issuerUserId}}/balance?role=issuer",
              "host": ["{{baseUrl}}"],
              "path": ["wallets", "{{issuerUserId}}", "balance"],
              "query": [
                {
                  "key": "role",
                  "value": "issuer"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "2. Gateway (Cross-chain Funding)",
      "item": [
        {
          "name": "Fund Arc Address",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"userId\": \"{{userId}}\",\n  \"sourceChain\": \"ETH\",\n  \"amount\": \"100.00\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/gateway/fund-arc",
              "host": ["{{baseUrl}}"],
              "path": ["gateway", "fund-arc"]
            },
            "description": "Deposit USDC from source chain and withdraw to Arc address"
          }
        },
        {
          "name": "Get Gateway Transaction Status",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/gateway/transactions/:txId",
              "host": ["{{baseUrl}}"],
              "path": ["gateway", "transactions", ":txId"],
              "variable": [
                {
                  "key": "txId",
                  "value": "gateway-1234"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "3. Products",
      "item": [
        {
          "name": "Create Product Request (Issuer)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Real Estate Fund A\",\n  \"description\": \"Premium commercial real estate in NYC\",\n  \"issuerAddress\": \"0x1234567890abcdef1234567890abcdef12345678\",\n  \"priceE6\": \"10000000\",\n  \"metadataURI\": \"ipfs://...\",\n  \"issuerUserId\": \"{{issuerUserId}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/products",
              "host": ["{{baseUrl}}"],
              "path": ["products"]
            },
            "description": "Issuer submits a product creation request. Product will be saved with 'pending' status and requires admin approval before deployment to blockchain."
          }
        },
        {
          "name": "List Products (Approved Only)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/products",
              "host": ["{{baseUrl}}"],
              "path": ["products"]
            },
            "description": "List all approved (deployed) products"
          }
        },
        {
          "name": "Get Pending Products (Admin)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/products/pending",
              "host": ["{{baseUrl}}"],
              "path": ["products", "pending"]
            },
            "description": "Admin retrieves list of products pending approval"
          }
        },
        {
          "name": "Approve Product (Admin)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"adminUserId\": \"{{adminUserId}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/products/{{productId}}/approve",
              "host": ["{{baseUrl}}"],
              "path": ["products", "{{productId}}", "approve"]
            },
            "description": "Admin approves a pending product and deploys it to blockchain"
          }
        },
        {
          "name": "Reject Product (Admin)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"adminUserId\": \"{{adminUserId}}\",\n  \"reason\": \"Insufficient documentation\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/products/{{productId}}/reject",
              "host": ["{{baseUrl}}"],
              "path": ["products", "{{productId}}", "reject"]
            },
            "description": "Admin rejects a pending product with optional reason"
          }
        },
        {
          "name": "Get Product Details",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/products/{{productId}}",
              "host": ["{{baseUrl}}"],
              "path": ["products", "{{productId}}"]
            }
          }
        },
        {
          "name": "Get Product Total Units",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/products/{{productId}}/total-units",
              "host": ["{{baseUrl}}"],
              "path": ["products", "{{productId}}", "total-units"]
            }
          }
        },
        {
          "name": "Deactivate Product (Issuer)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"issuerUserId\": \"{{issuerUserId}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/products/{{productId}}/deactivate",
              "host": ["{{baseUrl}}"],
              "path": ["products", "{{productId}}", "deactivate"]
            },
            "description": "Issuer deactivates product to prevent new investments. Must be called before refunding investors."
          }
        },
        {
          "name": "Refund Investor (Issuer)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"issuerUserId\": \"{{issuerUserId}}\",\n  \"investorAddress\": \"0xInvestorAddressHere\",\n  \"units\": \"100\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/products/{{productId}}/refund",
              "host": ["{{baseUrl}}"],
              "path": ["products", "{{productId}}", "refund"]
            },
            "description": "Issuer refunds investor by burning units and returning USDC. Product must be deactivated first."
          }
        },
        {
          "name": "Withdraw Subscription Funds (Issuer)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"issuerUserId\": \"{{issuerUserId}}\",\n  \"amountE6\": \"1000000000\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/products/{{productId}}/withdraw",
              "host": ["{{baseUrl}}"],
              "path": ["products", "{{productId}}", "withdraw"]
            },
            "description": "Issuer withdraws subscription funds (USDC) from the contract treasury."
          }
        },
        {
          "name": "Get Treasury Balance",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/products/treasury/balance",
              "host": ["{{baseUrl}}"],
              "path": ["products", "treasury", "balance"]
            },
            "description": "Get total USDC balance held in the contract treasury."
          }
        }
      ]
    },
    {
      "name": "4. Investment",
      "item": [
        {
          "name": "Subscribe to Product",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"userId\": \"{{userId}}\",\n  \"productId\": {{productId}},\n  \"amountE6\": \"50000000\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/invest/subscribe",
              "host": ["{{baseUrl}}"],
              "path": ["invest", "subscribe"]
            },
            "description": "Purchase product units with USDC. The system will:\n1. Verify product is active and get price per unit\n2. Calculate units = amountE6 / priceE6 (integer division)\n3. Calculate actual cost = units * priceE6\n4. Check user has sufficient USDC balance\n5. Approve actual cost to Ledger contract\n6. Execute subscribe transaction\n\nExample: If product price is 10 USDC/unit and you send 25 USDC:\n- Units purchased: 2\n- Actual cost: 20 USDC\n- Remaining: 5 USDC stays in your wallet\n\nMinimum amountE6 must be >= product price, otherwise will fail with 'Amount too small' error."
          }
        }
      ]
    },
    {
      "name": "5. Dividends",
      "item": [
        {
          "name": "Declare Dividend (Issuer)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"issuerUserId\": \"{{issuerUserId}}\",\n  \"productId\": {{productId}},\n  \"amountE6\": \"1000000\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/dividends/declare",
              "host": ["{{baseUrl}}"],
              "path": ["dividends", "declare"]
            },
            "description": "Issuer declares dividend for a product. Uses issuer's wallet to sign transaction."
          }
        },
        {
          "name": "Claim Dividend (Investor)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"userId\": \"{{userId}}\",\n  \"productId\": {{productId}}\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/dividends/claim",
              "host": ["{{baseUrl}}"],
              "path": ["dividends", "claim"]
            },
            "description": "Investor claims pending dividend. Uses investor's wallet to sign transaction."
          }
        }
      ]
    },
    {
      "name": "6. Portfolio",
      "item": [
        {
          "name": "Get User Portfolio",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/portfolio/{{userId}}",
              "host": ["{{baseUrl}}"],
              "path": ["portfolio", "{{userId}}"]
            },
            "description": "Get user holdings, balances, and pending dividends"
          }
        },
        {
          "name": "Get Product Holding",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/portfolio/{{userId}}/product/{{productId}}",
              "host": ["{{baseUrl}}"],
              "path": ["portfolio", "{{userId}}", "product", "{{productId}}"]
            }
          }
        },
        {
          "name": "Get USDC Balance",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/portfolio/{{userId}}/usdc-balance?role=investor",
              "host": ["{{baseUrl}}"],
              "path": ["portfolio", "{{userId}}", "usdc-balance"],
              "query": [
                {
                  "key": "role",
                  "value": "investor",
                  "description": "investor (default) or issuer"
                }
              ]
            },
            "description": "Get user's USDC balance on ARC-TESTNET"
          }
        },
        {
          "name": "Get USDC Allowance",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/portfolio/{{userId}}/usdc-allowance?role=investor",
              "host": ["{{baseUrl}}"],
              "path": ["portfolio", "{{userId}}", "usdc-allowance"],
              "query": [
                {
                  "key": "role",
                  "value": "investor",
                  "description": "investor (default) or issuer"
                }
              ]
            },
            "description": "Get USDC allowance approved for the ledger contract"
          }
        }
      ]
    },
    {
      "name": "Health Check",
      "item": [
        {
          "name": "Health Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/health",
              "host": ["{{baseUrl}}"],
              "path": ["health"]
            }
          }
        },
        {
          "name": "Root",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/",
              "host": ["{{baseUrl}}"],
              "path": [""]
            }
          }
        }
      ]
    }
  ]
}
